#!/bin/bash

#
# Copyright (c) 2014 Kévin THIERRY <kevin.thierry@open.eurogiciel.org>
#
# See the file LICENSE for copying permission.
#

help()
{
    echo
    echo "Generates a status of the opened Gerrit reviews which didn't receive any activity in the last N days."
    echo ""
    echo "Usage:"
    echo "  tizen-info-gerrit-status <age_in_days> <template>"
    echo
    echo "<template> can contains any macro listed by \"tizen-info -h\" plus the macro \"__GERRIT_ACTION__\" which will take different values according to their status. Values are:"
    echo "  * TO_MERGE"
    echo "  * TO_REVIEW"
    echo "..* TO_VERIFY"
    echo "  * TO_REVIEW_AND_VERIFY"
    echo "  * INVALID"
    echo
}

if [ "$#" -ne 2 ]
then
    help
    exit 0
fi

AGE=$1
TEMPLATE=$2

# Changes to merge
tizen-info -q "is:open age:${AGE}d label:Code-Review+2 label:Verified+1 NOT label:Verified-1 NOT label:Code-Review-2" -t $TEMPLATE | sed "s!__GERRIT_ACTION__!TO_MERGE!g"

# Changes to review
tizen-info -q "status:open age:${AGE}d label:Verified+1 NOT label:Verified-1 NOT label:Code-Review-2 NOT label:Code-Review+2" -t $TEMPLATE | sed "s!__GERRIT_ACTION__!TO_REVIEW!g"

# Changes to verify
tizen-info -q "status:open age:${AGE}d label:Code-Review+2 NOT label:Verified+1 NOT label:Verified-1 NOT label:Code-Review-2" -t $TEMPLATE | sed "s!__GERRIT_ACTION__!TO_VERIFY!g"

# Changes to review and verify
tizen-info -q "status:open age:${AGE}d NOT label:Code-Review+2 NOT label:Verified+1 NOT label:Verified-1 NOT label:Code-Review-2" -t $TEMPLATE | sed "s!__GERRIT_ACTION__!TO_REVIEW_AND_VERIFY!g"

# Invalid changes
tizen-info -q "status:open age:${AGE}d (label:Verified-1 OR label:Code-Review-2)" -t $TEMPLATE | sed "s!__GERRIT_ACTION__!INVALID!g"

exit 0
